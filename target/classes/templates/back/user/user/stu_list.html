<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>layuiAdmin 网站用户</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="../../../layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="../../../layuiadmin/style/admin.css" media="all">
</head>
<body>

<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-form layui-card-header layuiadmin-card-header-auto">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">学号</label>
          <div class="layui-input-block">
            <input type="text" name="stuNo" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">姓名</label>
          <div class="layui-input-block">
            <input type="text" name="stuName" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline"  th:if="${session.adminEmployer} == '0'">
          <label class="layui-form-label">班级</label>
          <div class="layui-input-block">
            <input type="text" name="stuClass" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline"  th:if="${session.adminEmployer} == '1'">
          <label class="layui-form-label">班级</label>
          <div class="layui-input-block">
            <input type="text" name="stuClass" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline"  th:if="${session.adminEmployer} == '2'">
          <label class="layui-form-label">班级</label>
          <div class="layui-input-block">
            <input type="text" name="stuClass" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">宿舍</label>
          <div class="layui-input-block">
            <input type="text" name="dormitory" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline" th:if="${session.adminEmployer} == '0'">
          <label class="layui-form-label">学院</label>
          <div class="layui-input-block">
            <input type="text" name="faculty" placeholder="请输入" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">职务</label>
          <div class="layui-input-block">
            <select name="committee" id="committee">
              <option value="">不限</option>
              <option value="团支书">团支书</option>
              <option value="班长">班长</option>
              <option value="组织委员">组织委员</option>
              <option value="宣传委员">宣传委员</option>
              <option value="权益委员">权益委员</option>
              <option value="学习委员">学习委员</option>
              <option value="生活委员">生活委员</option>
              <option value="科创委员">科创委员</option>
              <option value="心理委员">心理委员</option>
              <option value="文艺委员">文艺委员</option>
              <option value="体育委员">体育委员</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">寝室长</label>
          <div class="layui-input-block">
            <select name="shepherd" id="shepherd">
              <option value="">不限</option>
              <option value="1">是</option>
              <option value="0">否</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">性别</label>
          <div class="layui-input-block">
            <select name="sex">
              <option value="">不限</option>
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn layuiadmin-btn-useradmin" lay-submit lay-filter="LAY-user-front-search">
            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="layui-card-body">
      <div style="padding-bottom: 10px;">
        <!--<button class="layui-btn layuiadmin-btn-useradmin" data-type="batchDel" th:if="${session.adminEmployer} == '0'">批量删除</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="batchDel" th:if="${session.adminEmployer} == '1'">批量删除</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="batchDel" th:if="${session.adminEmployer} == '2'">批量删除</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="batchDel" th:if="${session.adminEmployer} == '3'">批量删除</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="add" th:if="${session.adminEmployer} == '0'">添加</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="add" th:if="${session.adminEmployer} == '1'">添加</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="add" th:if="${session.adminEmployer} == '2'">添加</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="add" th:if="${session.adminEmployer} == '3'">添加</button>
-->

        <button class="layui-btn layuiadmin-btn-useradmin" data-type="batchDel">批量删除</button>
        <button class="layui-btn layuiadmin-btn-useradmin" data-type="add">添加</button>
        <button class="layui-btn layui-btn-sm " data-type="importData" id="importData" onclick="javascript:return false;">导入</button>
        <button class="layui-btn layui-btn-sm " id="download" onclick="download('学生信息.xlsx')">下载模板</button>
      </div>

      <table id="tableData" lay-filter="LAY-user-manage" ></table>
      <script type="text/html" id="photo">
                  <img style="display: inline-block; width: 50%; height: 100%;" src= {{ d.photo }}>
      </script>
      <script type="text/html" id="table-useradmin-webuser">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
      </script>
    </div>
  </div>
</div>

<script src="../../../layuiadmin/layui/layui.js"></script>

<script>
  layui.config({
    base: '../../../layuiadmin/' //静态资源所在路径
  }).extend({
    index: 'lib/index' //主入口模块
  }).use(['index', 'useradmin', 'table', 'form', 'layer', 'laydate', 'jquery', 'upload'], function(){
    var $ = layui.$
            ,form = layui.form
            ,table = layui.table
            ,layer = layui.layer
            ,laydate = layui.laydate
            , layer = layui.layer
            , upload = layui.upload

    upload.render({
      elem: "#importData",//导入id
      url: "/excelUpload/addMoreStu/",
      accept: "file",
      exts: 'xls|xlsx|xlsm|xlt|xltx|xltm',
      before: function(obj) {
        layer.msg('文件上传中...', {
          icon: 16,
          shade: 0.01,
          time: 0
        })
      },
      done: function (res) {
        console.log(res)
        layer.close(layer.msg());//关闭上传提示窗口
        if (res.code == 0) {
        }else{
          // return layer.msg('上传失败');
          layer.msg(res.message,{icon:5});
        }
      }
    });

    //方法级渲染
    table.render({
      elem: '#tableData'
      ,id: 'tableData'
      ,url: '/admin/user/stu_list'
      ,title: '学生用户'
      ,toolbar: '#topToolBar'
      ,cellMinWidth:200
      ,page: true
      ,limit: 10
      ,height: 'full-221'
      ,cols: [
        [
          {checkbox: true, fixed: true}
          ,{type:'numbers', field:'no',title: '序号',  fixed: 'left',align:"center"}
          ,{field:'stuNo', title: '学号', width:100, sort: true, align:'center'}
          ,{field:'stuName', title: '姓名', width:80, sort: true, align:'center'}
          ,{field:'photo', title: '照片', width:100, align:'center', templet: '#photo'}
          ,{field:'sex', title: '性别', width:75, sort: true, align:'center'}
          ,{field:'faculty', title: '学院', width:120, sort: true, align:'center'}
          ,{field:'stuClass', title: '班级', width:120, sort: true, align:'center'}
          ,{field:'dormitory', title: '宿舍', width:80, sort: true, align:'center'}
          ,{field:'committee', title: '职务', width:80, align:'center'}
          ,{field:'tel', title: '手机', width:100, align:'center'}
          ,{field:'email', title: '邮箱', width:100, align:'center'}
          // ,{field:'qq', title: 'qq', width:80, align:'center'}
          ,{title: '操作', toolbar:'#table-useradmin-webuser', width:180, align:'center'}
        ]
      ]
      ,parseData: function (res) {
        return {
          "code": 0,
          "msg": res.msg,
          "data": res.payload.content,
          "count": res.payload.total
        }
      }
    });

    // upload.render({
    //   elem: "#importData",//导入id
    //   url: "/excelUpload/importData/",
    //   accept: "file",
    //   exts: 'xls|xlsx|xlsm|xlt|xltx|xltm',
    //   before: function(obj) {
    //     layer.msg('文件上传中...', {
    //       icon: 16,
    //       shade: 0.01,
    //       time: 0
    //     })
    //   },
    //   done: function (res) {
    //     console.log(res)
    //     layer.close(layer.msg());//关闭上传提示窗口
    //     if (res.code == 0) {
    //     }else{
    //       // return layer.msg('上传失败');
    //       layer.msg(res.message,{icon:5});
    //     }
    //   }
    // });

    //监听行工具事件
    table.on('tool(LAY-user-manage)', function(obj) {

      var data = obj.data;
      var id = data.id;

      if (obj.event === 'del') {
        layer.confirm('真的要删除这一行么', function (index) {
          $.ajax({
            url: '/stu/admin/delStudent',
            dataType: 'text',
            data: {id: id},
            success: function (res) {
              if (res.code == 200) {
                layer.msg(res.msg,{time:1000,icon:5})
              }else{
                layer.msg('删除成功', {
                  time: 1000, icon: 6
                })
                location.reload()
              }
            },
            error:function (data) {
              layer.msg("删除学生信息时发生错误，请重试...",{time:1000,icon:7})
              return false;
            }
          })
          obj.del();
          layer.close(index);
        });

      } else if (obj.event === 'edit') {
        //编辑教师信息
        layer.open({
          type: 2,
          title: '修改学生用户信息',
          maxmin: true,
          // area: ['860px', '520px'],
          shadeClose: true, //点击遮罩关闭
          content: '/stu/admin/toStudentEdit/' + id,
          area: screen() < 1 ? ['90%', '450px'] : ['500px', '450px']
          // area: ['500px', '450px']
          ,btn: ['修改', '取消']
          ,yes: function(index, layero){
            var iframeWindow = window['layui-layer-iframe'+ index]
                    ,submitID = 'LAY-user-front-submit'
                    ,submit = layero.find('iframe').contents().find('#'+ submitID);

            //监听提交
            iframeWindow.layui.form.on('submit('+ submitID +')', function(data){
              var field = data.field; //获取提交的字段
              console.log(field)
              //提交 Ajax 成功后，静态更新表格中的数据
              //$.ajax({});
              $.ajax({
                //几个参数需要注意一下
                type: "POST",               //方法类型
                url: "/stu/admin/updateStudent",       //url
                dataType: 'JSON',
                async: false,
                data: field,
                success: function (res) {
                  if (res.code === 200) {
                    layer.msg(res.msg,{time:1000,icon:5})
                  } else {
                    layer.msg('学生信息修改成功!', {icon: 6, time: 2000,end: function f() {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index)
                      }})
                  }
                },
                error:function (data) {
                  layer.msg("修改学生用户信息时发生错误，请重试...",{time:1000,icon:7})
                }
              });

              table.reload('tableData'); //数据刷新
              table.reload('tableData'); //数据刷新
              layer.close(index); //关闭弹层
            });
            submit.trigger('click');
          }
        })
      }
    })



    //监听搜索
    form.on('submit(LAY-user-front-search)', function(data){
      var field = data.field;
      console.log(field)
      var shepherd = field.shepherd;
      if(shepherd == ""){
        shepherd = null;
      }
      console.log(shepherd)

      //执行重载
      table.reload('tableData', {
        method: 'post'
        ,page: {
          curr : 1
        }
        ,where: {
          stuNo: field.stuNo
          ,stuName: field.stuName
          ,stuClass: field.stuClass
          ,dormitory: field.dormitory
          ,faculty: field.faculty
          ,shepherd: shepherd
          ,committee: field.committee
          ,sex: field.sex
          // ,page: 1
          // ,limit: 10
        }
      });
    });

    //事件
    var active = {
      batchDel: function(){
        var checkStatus = table.checkStatus('tableData')
                ,checkData = checkStatus.data; //得到选中的数据

        if(checkData.length === 0){
          return layer.msg('请选择数据');
        }

        layer.confirm('确定删除吗？', function(index) {
          //执行 Ajax 后重载
          var str = "";
          for (var i = 0; i < checkData.length; i++) {
            if(i + 1 == checkData.length){
              str += checkData[i].id;
            }else{
              str += checkData[i].id + ",";
            }
          }

          $.ajax({
            url: '/stu/admin/bacthDelStudent',
            type: 'POST',
            data: {
              "data" : str
            },
            success: function (res) {
              if (res.code == 100) {
                ajaxCode = 100;
              } else if (res.code == 200) {
                if (res.extend.mc_msg != null) {
                  layer.msg(res.extend.mc_msg, {time: 2000, icon: 5});
                } else {
                  ajaxCode = 200;
                }
              }
            },
            error: function () {
              layer.msg("删除失败，请重试!", {time: 1000, icon: 7});
            }
          })

          // table.reload('bjjsTable');
          // table.reload('bjjsTable');
          location.reload()
          layer.msg('已删除');
        });
      },
      add: function(){
        layer.open({
          type:  2                //利用iframe框架的弹出层
          ,title: '添加学生用户信息'
          ,maxmin: true
          ,content: '/back/user/user/stu_userform'
          // ,area: ['860px', '520px']
          // ,area: ['500px', '450px']
          ,area: screen() < 1 ? ['90%', '450px'] : ['500px', '450px']
          ,btn: ['提交', '取消']
          ,yes: function(index, layero){
            var iframeWindow = window['layui-layer-iframe'+ index]
                    ,submitID = 'LAY-user-front-submit'
                    ,submit = layero.find('iframe').contents().find('#'+ submitID);

            //监听提交
            iframeWindow.layui.form.on('submit('+ submitID +')', function(data){
              var field = data.field; //获取提交的字段
              console.log(field)
              //提交 Ajax 成功后，静态更新表格中的数据
              //$.ajax({});
              $.ajax({
                //几个参数需要注意一下
                type: "POST",               //方法类型
                url: "/stu/admin/addStudent",       //url
                dataType: 'JSON',
                async: false,
                data: field,
                success: function (res) {
                  if (res.code === 200) {
                    layer.msg(res.msg,{time:1000,icon:5})
                  } else {
                    layer.msg('学生用户信息添加成功!', {icon: 6, time: 2000,end: function f() {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index)
                      }})
                  }
                },
                error:function (data) {
                  layer.msg("添加学生用户信息时发生错误，请重试...",{time:1000,icon:7})
                }
              });
              table.reload('tableData'); //数据刷新
              table.reload('tableData'); //数据刷新
              layer.close(index); //关闭弹层
            });

            submit.trigger('click');
          }
        });
      }
    };


    //判断浏览器大小方法
    function screen() {
      //获取当前窗口的宽度
      var width = $(window).width();
      if (width > 768) {
        return 1;   //小屏幕
      } else {
        return 0;   //超小屏幕
      }
    }

    $('.layui-btn.layuiadmin-btn-useradmin').on('click', function(){
      var type = $(this).data('type');
      active[type] ? active[type].call(this) : '';
    });
  });
</script>

<script>
  function download(res) {
    window.open("https://www.gejiba.com/down.php/93cb5b6034e95edfd71803bdf5b54557.xlsx");
  }
</script>

</body>
</html>
